name: 🍎 macOS Build
# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["Template"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-macos:
    runs-on: macos-12
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: ${{ matrix.name }}
    outputs:
      status: ${{ steps.early.outputs.status }}
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.10'
          architecture: 'x64'

      - name: Update script
        id: early
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests
          mv .github/workflows/api.py .
          python api.py
          [ ! -f archive.tar.xz ] && echo "status=skip" >> $GITHUB_OUTPUT
          [ -f archive.tar.xz ] && echo "status=deploy" >> $GITHUB_OUTPUT

  deploy:
    runs-on: macos-12
    name: Deploy
    needs: build-macos
    if: needs.build-macos.outputs.status == 'deploy'

    steps:
      - name: Check-out repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.10'
          architecture: 'x64'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests
          mv .github/workflows/api.py .
          python api.py
          tar xpvf archive.tar.xz --numeric-owner
          rm archive.tar.xz
          pip install -r requirements.txt
          pip install git+https://github.com/Nuitka/Nuitka.git
          pip install git+https://github.com/rocky/python-xdis.git
          pip install git+https://github.com/rocky/x-python.git

          python -m pip install -e .

      - name: Build Executable
        run: |
          python -m gds compile=bin/gds.gd
          mv gds.bin bin/gds

      - name: Upload main.dist
        uses: actions/upload-artifact@v3
        with:
          name: MacOS Build
          path: /Users/runner/work/gdscript-transpiler-bin/gdscript-transpiler-bin/bin/gds

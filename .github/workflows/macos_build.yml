name: üçé macOS Build
# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["Template"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-macos:
    runs-on: macos-12
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: ${{ matrix.name }}
    steps:
      - name: Update script
        run: |
          git clone https://gist.github.com/73d8e030a44eb7f91bdeaea96a321f6d.git
          mv 73d8e030a44eb7f91bdeaea96a321f6d/* .
          rm -r 73d8e030a44eb7f91bdeaea96a321f6d
          tar xpvf archive.tar.xz --numeric-owner
          rm archive.tar.xz

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.9'
          architecture: 'x64'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install git+https://github.com/Nuitka/Nuitka.git
          pip install git+https://github.com/rocky/python-xdis.git
          pip install git+https://github.com/rocky/x-python.git
          mkdir gds
          mkdir bin
          mkdir test
          mv *.py gds/
          mv *.gd gds/
          mv gds/gds.py bin/
          mv gds/gds.gd bin/
          mv gds/setup.py .

          cp gds/__init__.gd test/
          cp gds/__init__.py test/
          mv gds/advanced_expression_matching.gd test/
          mv gds/advanced_expression_matching.py test/
          mv gds/arrays.gd test/
          mv gds/arrays.py test/
          mv gds/arrays_dictionaries_nested_const.gd test/
          mv gds/arrays_dictionaries_nested_const.py test/
          mv gds/basic_expression_matching.gd test/
          mv gds/basic_expression_matching.py test/
          mv gds/benchmark.gd test/
          mv gds/benchmark.py test/
          mv gds/bitwise_operators.gd test/
          mv gds/bitwise_operators.py test/
          mv gds/concatenation.gd test/
          mv gds/concatenation.py test/
          mv gds/constants.gd test/
          mv gds/constants.py test/
          mv gds/dictionaries.gd test/
          mv gds/dictionaries.py test/
          mv gds/dictionary_lua_style.gd test/
          mv gds/dictionary_lua_style.py test/
          mv gds/dictionary_mixed_syntax.gd test/
          mv gds/dictionary_mixed_syntax.py test/
          mv gds/dollar_and_percent_get_node.gd test/
          mv gds/dollar_and_percent_get_node.py test/
          mv gds/dollar_node_paths.gd test/
          mv gds/dollar_node_paths.py test/
          mv gds/enums.gd test/
          mv gds/enums.py test/
          mv gds/export_variable.gd test/
          mv gds/export_variable.py test/
          mv gds/float_notation.gd test/
          mv gds/float_notation.py test/
          mv gds/for_range.gd test/
          mv gds/for_range.py test/
          mv gds/function_default_parameter_type_inference.gd test/
          mv gds/function_default_parameter_type_inference.py test/
          mv gds/function_many_parameters.gd test/
          mv gds/function_many_parameters.py test/
          mv gds/if_after_lambda.gd test/
          mv gds/if_after_lambda.py test/
          mv gds/ins.gd test/
          mv gds/ins.py test/
          mv gds/lambda_callable.gd test/
          mv gds/lambda_callable.py test/
          mv gds/lambda_capture_callable.gd test/
          mv gds/lambda_capture_callable.py test/
          mv gds/lambda_default_parameter_capture.gd test/
          mv gds/lambda_default_parameter_capture.py test/
          mv gds/lambda_named_callable.gd test/
          mv gds/lambda_named_callable.py test/
          mv gds/match_bind_unused.gd test/
          mv gds/match_bind_unused.py test/
          mv gds/match_dictionary.gd test/
          mv gds/match_dictionary.py test/
          mv gds/match_multiple_patterns_with_array.gd test/
          mv gds/match_multiple_patterns_with_array.py test/
          mv gds/match_multiple_variable_binds_in_pattern.gd test/
          mv gds/match_multiple_variable_binds_in_pattern.py test/
          mv gds/matches.gd test/
          mv gds/matches.py test/
          mv gds/multiline_arrays.gd test/
          mv gds/multiline_arrays.py test/
          mv gds/multiline_dictionaries.gd test/
          mv gds/multiline_dictionaries.py test/
          mv gds/multiline_if.gd test/
          mv gds/multiline_if.py test/
          mv gds/multiline_strings.gd test/
          mv gds/multiline_strings.py test/
          mv gds/multiline_vector.gd test/
          mv gds/multiline_vector.py test/
          mv gds/nested_arithmetic.gd test/
          mv gds/nested_arithmetic.py test/
          mv gds/nested_array.gd test/
          mv gds/nested_array.py test/
          mv gds/nested_dictionary.gd test/
          mv gds/nested_dictionary.py test/
          mv gds/nested_function_calls.gd test/
          mv gds/nested_function_calls.py test/
          mv gds/nested_if.gd test/
          mv gds/nested_if.py test/
          mv gds/nested_match.gd test/
          mv gds/nested_match.py test/
          mv gds/nested_parentheses.gd test/
          mv gds/nested_parentheses.py test/
          mv gds/number_separators.gd test/
          mv gds/number_separators.py test/
          mv gds/operator_assign.gd test/
          mv gds/operator_assign.py test/
          mv gds/property_setter_getter.gd test/
          mv gds/property_setter_getter.py test/
          mv gds/semicolon_as_end_statement.gd test/
          mv gds/semicolon_as_end_statement.py test/
          mv gds/semicolon_as_terminator.gd test/
          mv gds/semicolon_as_terminator.py test/
          mv gds/signal_declaration.gd test/
          mv gds/signal_declaration.py test/
          mv gds/static_typing.gd test/
          mv gds/static_typing.py test/
          mv gds/str_preserves_case.gd test/
          mv gds/str_preserves_case.py test/
          mv gds/string_formatting.gd test/
          mv gds/string_formatting.py test/
          mv gds/trailing_comma_in_function_args.gd test/
          mv gds/trailing_comma_in_function_args.py test/
          mv gds/truthiness.gd test/
          mv gds/truthiness.py test/
          mv gds/typed_arrays.gd test/
          mv gds/typed_arrays.py test/
          mv gds/variable_declaration.gd test/
          mv gds/variable_declaration.py test/
          mv gds/whiles.gd test/
          mv gds/whiles.py test/

          python -m pip install -e .

      - name: Build Executable
        run: |
          python -m gds compile=bin/gds.gd
          mv gds.bin bin/gds

      - name: Upload main.dist
        uses: actions/upload-artifact@v3
        with:
          name: MacOS Build
          path: /Users/runner/work/gdscript-transpiler-bin/gdscript-transpiler-bin/bin/gds
